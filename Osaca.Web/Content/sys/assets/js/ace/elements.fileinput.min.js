(function(n,t){var s="multiple"in document.createElement("INPUT"),u="FileList"in window,h="FileReader"in window,r="File"in window,i=function(t,i){var r=this,e=ace.helper.getAttrSettings(t,n.fn.ace_file_input.defaults),u,f;this.settings=n.extend({},n.fn.ace_file_input.defaults,i,e);this.$element=n(t);this.element=t;this.disabled=!1;this.can_reset=!0;this.$element.off("change.ace_inner_call").on("change.ace_inner_call",function(n,t){if(!r.disabled)return t===!0?void 0:l.call(r)});u=this.$element.closest("label").css({display:"block"});f=u.length==0?"label":"span";this.$element.wrap("<"+f+' class="ace-file-input" />');this.apply_settings();this.reset_input_field()};i.error={FILE_LOAD_FAILED:1,IMAGE_LOAD_FAILED:2,THUMBNAIL_FAILED:3};i.prototype.apply_settings=function(){var t=this,i,r;if(this.multi=this.$element.attr("multiple")&&s,this.well_style=this.settings.style=="well",this.well_style?(this.settings.thumbnail||(this.settings.thumbnail="small"),this.$element.parent().addClass("ace-file-multiple")):this.$element.parent().removeClass("ace-file-multiple"),this.$element.parent().find(":not(input[type=file])").remove(),this.$element.after('<span class="ace-file-container" data-title="'+this.settings.btn_choose+'"><span class="ace-file-name" data-title="'+this.settings.no_file+'">'+(this.settings.no_icon?'<i class="'+ace.vars.icon+this.settings.no_icon+'"><\/i>':"")+"<\/span><\/span>"),this.$label=this.$element.next(),this.$container=this.$element.closest(".ace-file-input"),i=!!this.settings.icon_remove,i){r=n('<a class="remove" href="#"><i class="'+ace.vars.icon+this.settings.icon_remove+'"><\/i><\/a>').appendTo(this.$element.parent());r.on(ace.click_event,function(n){var i,r;return(n.preventDefault(),!t.can_reset)?!1:(i=!0,t.settings.before_remove&&(i=t.settings.before_remove.call(t.element)),!i)?!1:(r=t.reset_input(),!1)})}this.settings.droppable&&u&&c.call(this)};i.prototype.show_file_list=function(t,i){var u=typeof t=="undefined"?this.$element.data("ace_input_files"):t,f,e,o,s,y,v,c,p,l;if(u&&u.length!=0){for(this.well_style&&(this.$label.find(".ace-file-name").remove(),this.settings.btn_change||this.$label.addClass("hide-placeholder")),this.$label.attr("data-title",this.settings.btn_change).addClass("selected"),f=0;f<u.length;f++){if(e="",o=!1,typeof u[f]=="string")e=u[f];else if(r&&u[f]instanceof File)e=n.trim(u[f].name);else if(u[f]instanceof Object&&u[f].hasOwnProperty("name"))e=u[f].name,u[f].hasOwnProperty("type")&&(o=u[f].type),u[f].hasOwnProperty("path")||(u[f].path=u[f].name);else continue;s=e.lastIndexOf("\\")+1;s==0&&(s=e.lastIndexOf("/")+1);e=e.substr(s);o==!1&&(o=/\.(jpe?g|png|gif|svg|bmp|tiff?)$/i.test(e)?"image":/\.(mpe?g|flv|mov|avi|swf|mp4|mkv|webm|wmv|3gp)$/i.test(e)?"video":/\.(mp3|ogg|wav|wma|amr|aac)$/i.test(e)?"audio":"file");y={file:"fa fa-file",image:"fa fa-picture-o file-image",video:"fa fa-film file-video",audio:"fa fa-music file-audio"};v=y[o];this.well_style?(this.$label.append('<span class="ace-file-name" data-title="'+e+'"><i class="'+ace.vars.icon+v+'"><\/i><\/span>'),c=i===!0&&r&&u[f]instanceof File?n.trim(u[f].type):"",p=h&&this.settings.thumbnail&&(c.length>0&&c.match("image")||c.length==0&&o=="image"),p&&(l=this,n.when(a.call(this,u[f])).fail(function(n){l.settings.preview_error&&l.settings.preview_error.call(l,e,n.code)}))):this.$label.find(".ace-file-name").attr({"data-title":e}).find(ace.vars[".icon"]).attr("class",ace.vars.icon+v)}return!0}};i.prototype.reset_input=function(){this.reset_input_ui();this.reset_input_field()};i.prototype.reset_input_ui=function(){this.$label.attr({"data-title":this.settings.btn_choose,"class":"ace-file-container"}).find(".ace-file-name:first").attr({"data-title":this.settings.no_file,"class":"ace-file-name"}).find(ace.vars[".icon"]).attr("class",ace.vars.icon+this.settings.no_icon).prev("img").remove();this.settings.no_icon||this.$label.find(ace.vars[".icon"]).remove();this.$label.find(".ace-file-name").not(":first").remove();this.reset_input_data()};i.prototype.reset_input_field=function(){this.$element.wrap("<form>").parent().get(0).reset();this.$element.unwrap()};i.prototype.reset_input_data=function(){this.$element.data("ace_input_files")&&(this.$element.removeData("ace_input_files"),this.$element.removeData("ace_input_method"))};i.prototype.enable_reset=function(n){this.can_reset=n};i.prototype.disable=function(){this.disabled=!0;this.$element.attr("disabled","disabled").addClass("disabled")};i.prototype.enable=function(){this.disabled=!1;this.$element.removeAttr("disabled").removeClass("disabled")};i.prototype.files=function(){return n(this).data("ace_input_files")||null};i.prototype.method=function(){return n(this).data("ace_input_method")||""};i.prototype.update_settings=function(t){this.settings=n.extend({},this.settings,t);this.apply_settings()};i.prototype.loading=function(t){if(t===!1)this.$container.find(".ace-file-overlay").remove(),this.element.removeAttribute("readonly");else{var r=typeof t=="string"?t:'<i class="overlay-content fa fa-spin fa-spinner orange2 fa-2x"><\/i>',i=this.$container.find(".ace-file-overlay");if(i.length==0){i=n('<div class="ace-file-overlay"><\/div>').appendTo(this.$container);i.on("click tap",function(n){return n.stopImmediatePropagation(),n.preventDefault(),!1});this.element.setAttribute("readonly","true")}i.empty().append(r)}};var c=function(){var n=this,t=this.$element.parent();t.off("dragenter").on("dragenter",function(n){n.preventDefault();n.stopPropagation()}).off("dragover").on("dragover",function(n){n.preventDefault();n.stopPropagation()}).off("drop").on("drop",function(t){var u,i,r;if(t.preventDefault(),t.stopPropagation(),!n.disabled)return(u=t.originalEvent.dataTransfer,i=u.files,!n.multi&&i.length>1&&(r=[],r.push(i[0]),i=r),i=f.call(n,i,!0),i===!1)?!1:(n.$element.data("ace_input_method","drop"),n.$element.data("ace_input_files",i),n.show_file_list(i,!0),n.$element.triggerHandler("change",[!0]),!0)})},l=function(){var n=this.element.files||[this.element.value];return(n=f.call(this,n,!1),n===!1)?!1:(this.$element.data("ace_input_method","select"),this.$element.data("ace_input_files",n),this.show_file_list(n,!0),!0)},a=function(t){var u=this,f=u.$label.find(".ace-file-name:last"),e=new n.Deferred,s=function(t,i){f.prepend("<img class='middle' style='display:none;' />");var r=f.find("img:last").get(0);n(r).one("load",function(){h.call(null,r,i)}).one("error",function(){c.call(null,r)});r.src=t},h=function(t,r){var p=y(t),o=u.settings.previewSize,s,l,a,h,c;if(o||(u.settings.previewWidth||u.settings.previewHeight?o={previewWidth:u.settings.previewWidth,previewHeight:u.settings.previewHeight}:(o=50,u.settings.thumbnail=="large"&&(o=150))),u.settings.thumbnail=="fit"?o=f.width():typeof o=="number"&&(o=parseInt(Math.min(o,f.width()))),s=v(t,o),s==null){n(this).remove();e.reject({code:i.error.THUMBNAIL_FAILED});return}l=!0;r&&r instanceof File&&(r.width=s.width,r.height=s.height,u.$element.trigger("file.preview.ace",{file:r}),u.$element.trigger(a=new n.Event("file.preview.ace"),{file:r}),a.isDefaultPrevented()&&(l=!1));l&&(h=s.previewWidth,c=s.previewHeight,u.settings.thumbnail=="small"?h=c=parseInt(Math.max(h,c)):f.addClass("large"),n(t).css({"background-image":"url("+s.src+")",width:h,height:c}).data("thumb",s.src).data("full",p).attr({src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="}).show());e.resolve()},c=function(){f.find("img").remove();e.reject({code:i.error.IMAGE_LOAD_FAILED})},o;return r&&t instanceof File?(o=new FileReader,o.onload=function(n){s(n.target.result,t)},o.onerror=function(){e.reject({code:i.error.FILE_LOAD_FAILED})},o.readAsDataURL(t)):t instanceof Object&&t.hasOwnProperty("path")&&s(t.path,null),e.promise()},v=function(t,i){var f=t.width,e=t.height,o,s,c;f=f>0?f:n(t).width();e=e>0?e:n(t).height();var h=!1,r=!1,u=!1;typeof i=="number"?h=i:i instanceof Object&&(i.previewWidth&&!i.previewHeight?u=i.previewWidth:i.previewHeight&&!i.previewWidth?r=i.previewHeight:i.previewWidth&&i.previewHeight&&(u=i.previewWidth,r=i.previewHeight));h?f>e?(u=h,r=parseInt(e/f*u)):(r=h,u=parseInt(f/e*r)):!r&&u?r=parseInt(e/f*u):r&&!u&&(u=parseInt(f/e*r));try{s=document.createElement("canvas");s.width=u;s.height=r;c=s.getContext("2d");c.drawImage(t,0,0,f,e,0,0,u,r);o=s.toDataURL()}catch(l){o=null}return o?(/^data\:image\/(png|jpe?g|gif);base64,[0-9A-Za-z\+\/\=]+$/.test(o)||(o=null),!o)?null:{src:o,previewWidth:u,previewHeight:r,width:f,height:e}:null},y=function(n){var t,i,r;try{i=document.createElement("canvas");i.width=n.width;i.height=n.height;r=i.getContext("2d");r.drawImage(n,0,0);t=i.toDataURL()}catch(u){t=null}return t?(/^data\:image\/(png|jpe?g|gif);base64,[0-9A-Za-z\+\/\=]+$/.test(t)||(t=null),!t)?null:t:null},f=function(n,t){var i=p.call(this,n,t);return i===-1?(this.reset_input(),!1):!i||i.length==0?(this.$element.data("ace_input_files")||this.reset_input(),!1):((i instanceof Array||u&&i instanceof FileList)&&(n=i),i=!0,this.settings.before_change&&(i=this.settings.before_change.call(this.element,n,t)),i===-1)?(this.reset_input(),!1):!i||i.length==0?(this.$element.data("ace_input_files")||this.reset_input(),!1):((i instanceof Array||u&&i instanceof FileList)&&(n=i),n)},e=function(n){return n?(typeof n=="string"&&(n=[n]),n.length==0)?null:new RegExp(".(?:"+n.join("|")+")$","i"):null},o=function(n){return n?(typeof n=="string"&&(n=[n]),n.length==0)?null:new RegExp("^(?:"+n.join("|").replace(/\//g,"\\/")+")$","i"):null},p=function(t,i){var a=e(this.settings.allowExt),v=e(this.settings.denyExt),y=o(this.settings.allowMime),p=o(this.settings.denyMime),w=this.settings.maxSize||!1,h,u,l,s,f,b,c,k;if(!(a||v||y||p||w))return!0;for(h=[],u={},l=0;l<t.length;l++){if(s=t[l],f=r?s.name:s,a&&!a.test(f)){"ext"in u||(u.ext=[]);u.ext.push(f);continue}else if(v&&v.test(f)){"ext"in u||(u.ext=[]);u.ext.push(f);continue}if(r){if((b=n.trim(s.type)).length>0)if(y&&!y.test(b)){"mime"in u||(u.mime=[]);u.mime.push(f);continue}else if(p&&p.test(b)){"mime"in u||(u.mime=[]);u.mime.push(f);continue}}else{h.push(s);continue}if(w&&s.size>w){"size"in u||(u.size=[]);u.size.push(f);continue}h.push(s)}return h.length==t.length?t:(c={ext:0,mime:0,size:0},"ext"in u&&(c.ext=u.ext.length),"mime"in u&&(c.mime=u.mime.length),"size"in u&&(c.size=u.size.length),this.$element.trigger(k=new n.Event("file.error.ace"),{file_count:t.length,invalid_count:t.length-h.length,error_list:u,error_count:c,dropped:i}),k.isDefaultPrevented())?-1:h};n.fn.aceFileInput=n.fn.ace_file_input=function(r,u){var f,e=this.each(function(){var e=n(this),t=e.data("ace_file_input"),o=typeof r=="object"&&r;t||e.data("ace_file_input",t=new i(this,o));typeof r=="string"&&(f=t[r](u))});return f===t?e:f};n.fn.ace_file_input.defaults={style:!1,no_file:"No File ...",no_icon:"fa fa-upload",btn_choose:"Choose",btn_change:"Change",icon_remove:"fa fa-times",droppable:!1,thumbnail:!1,allowExt:null,denyExt:null,allowMime:null,denyMime:null,maxSize:!1,previewSize:!1,previewWidth:!1,previewHeight:!1,before_change:null,before_remove:null,preview_error:null}})(window.jQuery);