function onAmountChanged(n){var i=$(n).attr("data-isvatable"),r=$(n).val(),u,t;i=="true"?(u=parseFloat($(n).closest("tr").find("input")[0].value),t=r*selfInviceAddManager.VAT,$(n).closest("tr").find("input")[2].value=t.toFixed(2)):$(n).closest("tr").find("input")[2].value=numeral("0").format("0.0")}var selfInviceAddManager,pageManager=function(){selfInviceAddManager=this;this.IsVatable=!1;this.VAT;var n=commonManger.getUrlVars().id,r=function(){u();try{v()}catch(n){}},u=function(){$("#ExpenseID").change(function(){a($(this).val())});$("#btnAddAmount").click(function(n){n.preventDefault();var t=$("#ExpenseID").val();t!==""?l():commonManger.showMessage("Required fields","Please enter all required fields.")});$("#SaveAll").click(function(n){n.preventDefault();f()});$("#addModal").on("shown.bs.modal",function(){$("#ExpenseID").val("");$("#Cost,#Amount").val("0.0")});var n=$("#listItems tbody");n.delegate("tr button.remove","click",function(n){n.preventDefault();var r=$(this).closest("tr");r&&r.css({transition:"background-color 1s","background-color":"red"}).fadeOut("slow").promise().done(function(){r.remove();i();t()})});n.delegate('tr input[type="number"]',"keyup change",function(){var i=$(this),r=i.attr("data-expid"),u=i.val(),e=i.attr("data-IsVatable"),f=function(t,i){n.find('tr input[data-parent-expid="'+t+'"]').val((i*(selfInviceAddManager.VAT||.05)).toFixed(2))};onAmountChanged(i);r&&u&&f(r,u);t()})},f=function(){var r=o();if(r){var u=$("#listItems tbody tr").map(function(n,t){var i=$(t).find("td:eq(0)").attr("data-inv-details-id");return(i?i:0)+",0,"+$(t).find("td:eq(0)").attr("data-expenseid")+","+numeral().unformat($(t).find("td:eq(2) input").val())+","+numeral().unformat($(t).find("td:eq(3) input").val())+","+numeral().unformat($(t).find("td:eq(4) input").val())}).get(),t=$("#TransporterID").val()*1>0?$("#TransporterID").val():"",i=$("#CraneDriverID").val()*1>0?$("#CraneDriverID").val():"",f=["InvoiceID","ClientID","AddDate","TotalAmount","Profit","ContainerNo","DeclarationNo","Notes","BillOfEntryDate","TransporterID","CraneDriverID"],s=[$("#InvoiceID").val(),$("#ClientID").val(),commonManger.dateFormat($("#AddDate").val()),numeral().unformat($("#TotalAmount").text()),numeral().unformat($("#TotalProfit").text()),$("#ContainerNo").val(),$("#DeclarationNo").val(),$("#Notes").val(),commonManger.dateFormat($("#BillOfEntryDate").val()),t,i],h=["InvoiceDetailsID","InvoiceID","ExpenseID","Cost","Amount","VAT"],n=!0;$("#listItems tbody tr").each(function(){var r=$(this).find("td:eq(1)").text().toLowerCase(),u=$(this).find("td:eq(2) input").val()*1,f=$(this).find("td:eq(3) input").val()*1;return r==="transport charges"&&t===""&&(u>0||f>0)?(n=!1,commonManger.showMessage("Required fields","Please select transporter name."),!1):r==="crane charges"&&i===""&&(u>0||f>0)?(n=!1,commonManger.showMessage("Required fields","Please select crane/driver name."),!1):void 0}).promise().done(function(){n&&e(f,s,h,u)})}else commonManger.showMessage("Data required","Please enter all mandatory fields.")},e=function(n,t,i,r){var u={fieldsMaster:n,valuesMaster:t,fieldsDetails:i,valuesDetails:r};dataService.callAjax("Post",JSON.stringify(u),"InvoiceAdd.aspx/SaveDataMasterDetails",s,commonManger.errorException)},o=function(){var t=!0,n={client:$("#ClientID").val(),gridLength:$("#listItems tbody").length,date:commonManger.dateFormat($("#AddDate").val()),container:$("#ContainerNo").val(),declaration:$("#DeclarationNo").val(),transporter:$("#TransporterID").val()*1>0?$("#TransporterID").val():"",craneDriver:$("#CraneDriverID").val()*1>0?$("#CraneDriverID").val():""};return(n.client===""||n.gridLength<=0||n.date===""||n.container===""||n.declaration==="")&&(t=!1),t},s=function(n){n=n.d;n.Status?window.location.href="InvoicePrint.aspx?id="+n.ID:commonManger.showMessage("Error!","Error occured!:"+n.message)},h=function(i){var u=$.parseXML(i.d),f=$.xml2json(u).list,e=$.xml2json(u).list1,r=$.xml2json(u).list2,l=$.xml2json(u).list3,o,s,h,c;f&&(o=$(f).map(function(n,t){return $("<option data-IsVatable="+t.IsVatable+" />").val(t.ExpenseID).text(t.ExpenseName)}).get(),$("#ExpenseID").append(o).trigger("chosen:updated").trigger("liszt:updated"),s=n?l:f,h=$(s).map(function(t,i){return $('<tr><td data-expenseid="'+i.ExpenseID+'" data-inv-details-id="'+(i.InvoiceDetailsID?i.InvoiceDetailsID:0)+'" class="center">'+(t+1)+"<\/td><td>"+i.ExpenseName+'<\/td>                             <td><input data-expid="'+i.ExpenseID+'" '+(i.ParentExpenseID?' data-parent-expid="'+i.ParentExpenseID+'"':"")+' type="number" value="'+numeral(i.Cost?i.Cost:i.DefaultValue).format("0.0")+'" /><\/td>                             <td><input data-IsVatable="'+i.IsVatable+'" data-expid="'+i.ExpenseID+'" type="number" value="'+numeral(i.Amount?i.Amount:i.DefaultValue).format("0.0")+'" /><\/td>                             <td><input readonly data-vatColmun data-expid="'+i.ExpenseID+'" '+(i.ParentExpenseID?' data-parent-expid="'+i.ParentExpenseID+'"':"")+' type="number" value="'+(n?numeral(i.VAT).format("0.0"):i.IsVatable=="true"?numeral((i.Amount?i.Amount:i.DefaultValue)*selfInviceAddManager.VAT).format("0.0"):numeral(0).format("0.0"))+'" /><\/td>                             <td><button class="btn btn-minier btn-danger remove" data-rel="tooltip" data-placement="top" data-original-title="Delete" title="Delete"><i class="fa fa-remove icon-only"><\/i><\/button><\/td><\/tr>')}).get(),$("#listItems tbody").append(h),t());e&&(c=$(e).map(function(n,t){return $("<option />").val(t.ClientID).text(t.ClientName)}).get(),$("#ClientID").append(c).trigger("chosen:updated").trigger("liszt:updated"));r&&($.each(r,function(n,t){$("#masterForm #"+n).val(t)}),$(".date-picker").text(function(){return commonManger.formatJSONDateCal($(this).text())}),r.TransporterID&&$("#TransporterID").select2("trigger","select",{data:{id:r.TransporterID,text:r.TransporterName}}),r.CraneDriverID&&$("#CraneDriverID").select2("trigger","select",{data:{id:r.CraneDriverID,text:r.CraneDriverName}}))},c=function(){var t="Invoices_Properties",i=n?{actionName:t,value:n}:{actionName:t};dataService.callAjax("Post",JSON.stringify(i),sUrl+"GetData"+(n?"":"Direct"),h,commonManger.errorException)},l=function(){var r=$("#Amount").val(),n,f,u;r=selfInviceAddManager.IsVatable=="true"?r*selfInviceAddManager.VAT:"0.00";n={ExpenseID:$("#ExpenseID").val(),ExpenseName:$("#ExpenseID option:selected").text(),Cost:$("#Cost").val(),Amount:$("#Amount").val(),VATAmount:r};n&&(f=$(n).map(function(n,t){return $('<tr><td data-expenseid="'+t.ExpenseID+'" data-inv-details-id="'+(t.InvoiceDetailsID?t.InvoiceDetailsID:0)+'" class="center">'+(n+1)+"<\/td><td>"+t.ExpenseName+'<\/td>                             <td><input type="number" value="'+numeral(t.Cost).format("0.0")+'" /><\/td>                             <td><input type="number" value="'+numeral(t.Amount).format("0.0")+'" /><\/td>                             <td><input type="number" readonly value="'+numeral(t.VATAmount).format("0.0")+'" /><\/td>                             <td><button class="btn btn-minier btn-danger remove" data-rel="tooltip" data-placement="top" data-original-title="Delete" title="Delete"><i class="fa fa-remove icon-only"><\/i><\/button><\/td><\/tr>')}).get(),u=!1,$("#listItems tbody tr").each(function(){$(this).children("td:eq(0)").attr("data-expenseid")===n.ExpenseID&&(u=!0)}),u?commonManger.showMessage("Data Exists:","Data already exists before."):($("#listItems tbody").append(f),t(),i()));$(".modal").modal("hide")},t=function(){var t=0,n=0,i=0;$("#listItems tbody tr").each(function(){try{var r=$(this).find("td:eq(2) input").val()*1,u=$(this).find("td:eq(3) input").val()*1,f=$(this).find("td:eq(4) input").val()*1;t+=numeral().unformat(r&&!isNaN(r)?r:0)*1;n+=numeral().unformat(u&&!isNaN(u)>0?u:0)*1;i+=numeral().unformat(f&&!isNaN(f)>0?f:0)*1}catch(e){console.log(e)}});n=n+i;$("#TotalAmount").text(numeral(n).format("0,0.0"));$("#TotalProfit").text(numeral(n-t).format("0,0.0"));n>0?$("#SaveAll").removeClass("hidden"):$("#SaveAll").addClass("hidden")},y=function(){$("#aspnetForm")[0].reset();$("#listItems tbody").html("");$("#TotalAmountDhs").text("0")},a=function(n){var t={actionName:"Expenses_SelectRow",value:n},i=function(n){var i=$.parseXML(n.d),t=$.xml2json(i).list;t&&($("#Cost").val(numeral(t.DefaultValue).format("0.00")),$("#Amount").val(numeral(t.DefaultValue).format("0.00")),selfInviceAddManager.IsVatable=t.IsVatable)};dataService.callAjax("Post",JSON.stringify(t),sUrl+"GetData",i,commonManger.errorException)},v=function(){var n=function(n){var t=$.parseXML(n.d),i=$.xml2json(t).list;selfInviceAddManager.VAT=parseFloat(i.Val);c()};dataService.callAjax("Post",JSON.stringify({actionName:"Settings_Select",value:"VAT"}),sUrl+"GetData",n,commonManger.errorException)},i=function(){$("#listItems tbody tr").each(function(n){$(this).find("td:eq(0)").text(n+1)})};return{Init:r}}();